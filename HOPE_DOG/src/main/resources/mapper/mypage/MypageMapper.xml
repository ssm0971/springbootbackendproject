<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.hope_dog.mapper.mypage.MypageMapper">

    <select id="mypageProfile" parameterType="Long" resultType="MypageDTO"> <!-- DTO의 패키지 경로로 수정 -->
        SELECT
        MEMBER_NO,
        MEMBER_NAME,
        MEMBER_PHONE_NUMBER,
        MEMBER_EMAIL
        FROM
        TBL_MEMBER
        WHERE
        MEMBER_NO = #{memberNo}
    </select>


    <!--    정보수정 페이지 조회-->
    <select id="viewProfile" parameterType="Long" resultType="MypageViewProfileDTO">
        SELECT MEMBER_NAME, MEMBER_NICKNAME, MEMBER_EMAIL,MEMBER_PHONE_NUMBER,MEMBER_ZIPCODE ,MEMBER_ADDRESS ,MEMBER_DETAIL_ADDRESS, MEMBER_PW
        FROM TBL_MEMBER m
        WHERE MEMBER_NO = #{memberNo}
    </select>

<!-- 닉네임 중복 검사-->
    <select id="checkedNickname" resultType="int">
        SELECT COUNT(*)
        FROM (
                 SELECT MEMBER_NICKNAME
                 FROM TBL_MEMBER
                 WHERE MEMBER_NICKNAME = #{memberNickname}
                   AND MEMBER_NICKNAME != #{currentNickname}  -- 현재 닉네임 제외
                 UNION ALL
                 SELECT MEMBER_NICKNAME
                 FROM TBL_MEMBER
                 WHERE MEMBER_NICKNAME = #{memberNickname}
                   AND MEMBER_NICKNAME != #{currentNickname}  -- 현재 닉네임 제외
             )
    </select>

    <!-- 이메일 중복 검사-->
    <select id="checkedEmail" resultType="int">
        SELECT COUNT(*)
        FROM (
                 SELECT MEMBER_EMAIL
                 FROM TBL_MEMBER
                 WHERE MEMBER_EMAIL = #{memberEmail}
                   AND MEMBER_EMAIL != #{currentEmail}  -- 현재 이메일 제외
                 UNION ALL
                 SELECT MEMBER_EMAIL
                 FROM TBL_MEMBER
                 WHERE MEMBER_EMAIL = #{centerMemberEmail}
                   AND MEMBER_EMAIL != #{currentEmail}  -- 현재 이메일 제외
             )
    </select>

<!--    회원정보수정-->
    <update id="updateProfile" parameterType="MypageUpdateProfileDTO">
        UPDATE TBL_CENTER_MEMBER
        SET
            MEMBER_NAME = #{memberName},
            MEMBER_EMAIL = #{memberEmail},
            MEMBER_PHONE_NUMBER = #{memberPhoneNumber},
            MEMBER_ADDRESS = #{centerMemberAddress},
            MEMBER_DETAIL_ADDRESS = #{memberDetailAddress}
            MEMBER_PW = COALESCE(NULLIF(#{memberNewPw}, #{memberPw}), MEMBER_PW)
        WHERE CENTER_MEMBER_NO = #{memberNo}
          AND CENTER_MEMBER_PW = #{memberPw}
    </update>

<!--    입양게시글조회-->
    <select id="mypageAdoptList" resultType="MypageAdoptListDTO">
        SELECT
            A.ADOPT_TITLE,
            A.ADOPT_STATUS,
            A.ADOPT_PERIODEND
        FROM TBL_ADOPT A
                 JOIN TBL_ADOPT_REQUEST AR ON A.ADOPT_NO = AR.ADOPT_NO
        WHERE AR.MEMBER_NO = #{memberNo}
    </select>

    <select id="mypageProtectList" resultType="MypageProtectDTO">
        SELECT
            P.PROTECT_TITLE,
            P.PROTECT_STATUS,
            P.PROTECT_PERIODEND
        FROM TBL_PROTECT P
                 JOIN TBL_PROTECT_REQUEST PR ON P.PROTECT_NO = PR.PROTECT_NO
        WHERE PR.MEMBER_NO = #{memberNo}
    </select>

    <select id="mypageVolunList" resultType="MypageVolunDTO">
        SELECT
            V.VOLUN_TITLE,
            V.VOLUN_STATUS,
            V.VOLUN_PERIODEND
        FROM TBL_VOLUN V
            JOIN TBL_VOLUN_REQUEST VR ON V.VOLUN_NO = VR.VOLUN_NO
        WHERE VR.MEMBER_NO = #{memberNo}
    </select>

    <select id="mypagePostsList" resultType="MypagePostsDTO">
        SELECT
            'CAR' AS TYPE,
            C.CAR_TITLE AS TITLE,
            M.MEMBER_NICKNAME AS WRITER,
            C.CAR_REGIDATE AS REGIDATE
        FROM
            TBL_CAR C
                JOIN
            TBL_MEMBER M ON C.CAR_WRITER = M.MEMBER_NO
        WHERE M.MEMBER_NO = #{memberNo}
        UNION ALL
        SELECT
            'COMMU' AS TYPE,
            CO.COMMU_TITLE AS TITLE,
            M.MEMBER_NICKNAME AS WRITER,
            CO.COMMU_REGIDATE AS REGIDATE
        FROM
            TBL_COMMU CO
                JOIN
            TBL_MEMBER M ON CO.COMMU_WRITER = M.MEMBER_NO
        WHERE M.MEMBER_NO = #{memberNo}
        UNION ALL
        SELECT
            'REVIEW' AS TYPE,
            R.REVIEW_TITLE AS TITLE,
            M.MEMBER_NICKNAME AS WRITER,
            R.REVIEW_REGIDATE AS REGIDATE
        FROM
            TBL_REVIEW R
                JOIN
            TBL_MEMBER M ON R.MEMBER_NO = M.MEMBER_NO
        WHERE M.MEMBER_NO = #{memberNo}
    </select>

<!--    <select id="selectTotal" resultType="int">-->
<!--        SELECT COUNT(*) AS TOTAL_COUNT-->
<!--        FROM (-->
<!--                 SELECT-->
<!--                     'CAR' AS TYPE,-->
<!--                     C.CAR_TITLE AS TITLE,-->
<!--                     M.MEMBER_NICKNAME AS WRITER,-->
<!--                     C.CAR_REGIDATE AS REGIDATE-->
<!--                 FROM-->
<!--                     TBL_CAR C-->
<!--                         JOIN TBL_MEMBER M ON C.CAR_WRITER = M.MEMBER_NO-->
<!--                 WHERE M.MEMBER_NO = #{memberNo}-->

<!--                 UNION ALL-->

<!--                 SELECT-->
<!--                     'COMMU' AS TYPE,-->
<!--                     CO.COMMU_TITLE AS TITLE,-->
<!--                     M.MEMBER_NICKNAME AS WRITER,-->
<!--                     CO.COMMU_REGIDATE AS REGIDATE-->
<!--                 FROM-->
<!--                     TBL_COMMU CO-->
<!--                         JOIN TBL_MEMBER M ON CO.COMMU_WRITER = M.MEMBER_NO-->
<!--                 WHERE M.MEMBER_NO = #{memberNo}-->

<!--                 UNION ALL-->

<!--                 SELECT-->
<!--                     'REVIEW' AS TYPE,-->
<!--                     R.REVIEW_TITLE AS TITLE,-->
<!--                     M.MEMBER_NICKNAME AS WRITER,-->
<!--                     R.REVIEW_REGIDATE AS REGIDATE-->
<!--                 FROM-->
<!--                     TBL_REVIEW R-->
<!--                         JOIN TBL_MEMBER M ON R.MEMBER_NO = M.MEMBER_NO-->
<!--                 WHERE M.MEMBER_NO = #{memberNo}-->
<!--             ) AS SUBQUERY-->
<!--    </select>-->

<!--    <select id="selectAllPage" parameterType="Criteria" resultType="MypagePostsDTO">-->
<!--    <![CDATA[-->
<!--        SELECT TYPE, TITLE, WRITER, REGIDATE-->
<!--        FROM (-->
<!--                 SELECT-->
<!--                     'CAR' AS TYPE,-->
<!--                     C.CAR_TITLE AS TITLE,-->
<!--                     M.MEMBER_NICKNAME AS WRITER,-->
<!--                     C.CAR_REGIDATE AS REGIDATE,-->
<!--                     ROWNUM AS RNUM-->
<!--                 FROM-->
<!--                     TBL_CAR C-->
<!--                         JOIN TBL_MEMBER M ON C.CAR_WRITER = M.MEMBER_NO-->
<!--                 WHERE M.MEMBER_NO = #{memberNo}-->

<!--                 UNION ALL-->

<!--                 SELECT-->
<!--                     'COMMU' AS TYPE,-->
<!--                     CO.COMMU_TITLE AS TITLE,-->
<!--                     M.MEMBER_NICKNAME AS WRITER,-->
<!--                     CO.COMMU_REGIDATE AS REGIDATE,-->
<!--                     ROWNUM AS RNUM-->
<!--                 FROM-->
<!--                     TBL_COMMU CO-->
<!--                         JOIN TBL_MEMBER M ON CO.COMMU_WRITER = M.MEMBER_NO-->
<!--                 WHERE M.MEMBER_NO = #{memberNo}-->

<!--                 UNION ALL-->

<!--                 SELECT-->
<!--                     'REVIEW' AS TYPE,-->
<!--                     R.REVIEW_TITLE AS TITLE,-->
<!--                     M.MEMBER_NICKNAME AS WRITER,-->
<!--                     R.REVIEW_REGIDATE AS REGIDATE,-->
<!--                     ROWNUM AS RNUM-->
<!--                 FROM-->
<!--                     TBL_REVIEW R-->
<!--                         JOIN TBL_MEMBER M ON R.MEMBER_NO = M.MEMBER_NO-->
<!--                 WHERE M.MEMBER_NO = #{memberNo}-->
<!--             ) AS SUBQUERY-->
<!--        WHERE RNUM > (#{page} - 1) * #{amount} AND RNUM <= #{page} * #{amount}-->
<!--        ]]>-->
<!--</select>-->


</mapper>